<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caricamento Foto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh */
        }
        input[type="file"] { display: none; }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s, visibility 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>
    <div id="toast" class="toast"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- CONFIGURAZIONE API ---
        // Modifica questo se il tuo sito non è in HTTPS o il percorso è diverso
        const API_BASE_URL = 'https://theallergist.it/api'; 
        // -------------------------

        const ALLERGEN_STRUCTURE = {
            "Alimenti": ["Alimenti Gruppo 1", "Alimenti Gruppo 2", "Alimenti Gruppo 3", "Alimenti Gruppo 4", "Alimenti Pediatrico", "Proteine del Latte", "Uovo"],
            "Inalanti": ["Inalanti Gruppo 1", "Inalanti Gruppo 2", "Inalanti Gruppo 3"],
            "Altri allergeni": ["Leguminose", "Pesci e Molluschi", "Rosacee", "Test Speciali", "Latex"]
        };
        
        // Funzione Toast globale
        function showToast(message, bgColor) {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.className = `toast show ${bgColor}`;
                setTimeout(() => toast.className = toast.className.replace("show", ""), 4000);
            }
        }

        // Funzione helper per le chiamate API
        async function apiFetch(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    ...options,
                    // Fondamentale per inviare/ricevere i cookie di sessione
                    credentials: 'include', 
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || `Errore ${response.status}`);
                }
                return data;
            } catch (error) {
                console.error(`Errore API (${endpoint}):`, error);
                throw error; // Rilancia l'errore per gestirlo nel componente
            }
        }


        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [profilo, setProfilo] = useState(null);
            const [authLoading, setAuthLoading] = useState(true); // Controlla il caricamento della sessione
            
            const [cognome, setCognome] = useState('');
            const [nome, setNome] = useState('');
            // Aggiunto stato per la data, con default a oggi
            const [dataTest, setDataTest] = useState(new Date().toISOString().split('T')[0]);

            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState('');
            const [stagedFiles, setStagedFiles] = useState({});
            
            const [activeCategory, setActiveCategory] = useState(null);
            const [showSettings, setShowSettings] = useState(false);

            const fileInputRef = useRef(null);

            // Controlla la sessione al caricamento dell'app
            useEffect(() => {
                const checkSession = async () => {
                    try {
                        const data = await apiFetch('check_session.php');
                        if (data.success) {
                            setProfilo(data.profilo);
                            setIsLoggedIn(true);
                        }
                    } catch (error) {
                        console.log("Nessuna sessione attiva.");
                    } finally {
                        setAuthLoading(false);
                    }
                };
                checkSession();
            }, []);

            const handleLogin = async (username, password) => {
                try {
                    const data = await apiFetch('login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    if (data.success) {
                        setProfilo(data.profilo);
                        setIsLoggedIn(true);
                        showToast(`Benvenuto, ${data.profilo.nome_studio}!`, 'bg-green-500');
                    }
                } catch (error) {
                    showToast(error.message, 'bg-red-500');
                }
            };
            
            const handleLogout = async () => {
                try {
                    await apiFetch('logout.php', { method: 'POST' });
                } catch (error) {
                    console.error("Errore durante il logout:", error);
                } finally {
                    setIsLoggedIn(false);
                    setProfilo(null);
                    setShowSettings(false);
                    showToast("Disconnessione riuscita.", 'bg-gray-500');
                }
            };

            const handleTakePhoto = (groupName) => {
                if (!cognome || !nome) {
                    showToast("Inserisci Nome e Cognome del paziente.", 'bg-yellow-500 text-black');
                    return;
                }
                fileInputRef.current.onchange = (event) => handleFileChange(event, groupName);
                fileInputRef.current.click();
            };

            const handleFileChange = (event, groupName) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setStagedFiles(prev => ({ ...prev, [groupName]: { file, preview: e.target.result } }));
                        showToast(`Foto per "${groupName}" aggiunta.`, 'bg-blue-500');
                    };
                    reader.readAsDataURL(file);
                }
                event.target.value = null; 
            };
            
            const handleUploadAll = async () => {
                if (Object.keys(stagedFiles).length === 0) {
                    showToast("Nessuna foto da caricare.", 'bg-red-500');
                    return;
                }
                setIsUploading(true);
                const filesToUpload = Object.entries(stagedFiles);

                try {
                    for (let i = 0; i < filesToUpload.length; i++) {
                        const [groupName, { file }] = filesToUpload[i];
                        setUploadProgress(`Caricamento ${i + 1}/${filesToUpload.length}: "${groupName}"...`);
                        
                        // Prepara FormData per l'invio
                        const formData = new FormData();
                        formData.append('foto', file);
                        formData.append('groupName', groupName);
                        formData.append('cognome', cognome.trim());
                        formData.append('nome', nome.trim());
                        formData.append('data', dataTest); // Aggiunge la data

                        // Invia il file al server (upload.php)
                        const data = await apiFetch('upload.php', {
                            method: 'POST',
                            body: formData // Non serve 'Content-Type', il browser lo imposta per FormData
                        });

                        if (!data.success) {
                            throw new Error(data.message || `Errore caricamento ${groupName}`);
                        }
                    }
                    
                    showToast('Tutti i file sono stati caricati!', 'bg-green-500');
                    handleNewPatient(true); // Resetta l'interfaccia
                } catch (error) {
                    showToast(`Errore durante il caricamento: ${error.message}`, 'bg-red-500');
                } finally {
                    setIsUploading(false);
                    setUploadProgress('');
                }
            };
            
            const handleNewPatient = (force = false) => {
                const confirmed = force || Object.keys(stagedFiles).length === 0 || confirm("Hai foto non caricate. Vuoi iniziare con un nuovo paziente? Le foto andranno perse.");
                if (confirmed) {
                    setStagedFiles({}); 
                    setCognome(''); 
                    setNome(''); 
                    setDataTest(new Date().toISOString().split('T')[0]); // Resetta la data
                    setActiveCategory(null);
                }
            };

            // Viste
            if (authLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <p className="text-gray-500 text-lg">Caricamento...</p>
                    </div>
                );
            }

            if (!isLoggedIn) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 pb-20 max-w-2xl mx-auto">
                    {showSettings && <SettingsModal onLogout={handleLogout} onClose={() => setShowSettings(false)} profilo={profilo} />}

                    <header className="bg-white p-4 rounded-xl shadow-md mb-6 sticky top-4 z-10">
                        <div className="flex items-center justify-between">
                            <h1 className="text-2xl font-bold text-gray-800">Caricamento Foto</h1>
                             <button onClick={() => setShowSettings(true)} className="text-gray-500 hover:text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                             </button>
                        </div>
                         <p className="text-sm text-green-600 font-medium mt-2">Connesso come: {profilo?.nome_studio}</p>
                    </header>
                    
                    <MainView 
                        cognome={cognome} setCognome={setCognome} 
                        nome={nome} setNome={setNome} 
                        dataTest={dataTest} setDataTest={setDataTest}
                        handleNewPatient={handleNewPatient} 
                        activeCategory={activeCategory} setActiveCategory={setActiveCategory} 
                        handleTakePhoto={handleTakePhoto} 
                        stagedFiles={stagedFiles} isUploading={isUploading}
                    />
                    
                    <FileList stagedFiles={stagedFiles} handleTakePhoto={handleTakePhoto} />

                    <button onClick={handleUploadAll} disabled={isUploading || Object.keys(stagedFiles).length === 0} className="w-full bg-green-500 text-white font-bold py-4 px-4 rounded-lg shadow-lg hover:bg-green-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed text-lg sticky bottom-4 z-10">
                        {isUploading ? uploadProgress : `Carica ${Object.keys(stagedFiles).length} File`}
                    </button>

                    <input type="file" accept="image/*" capture="environment" ref={fileInputRef} />
                </div>
            );
        }

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!username || !password) {
                    showToast("Inserisci username e password.", 'bg-yellow-500 text-black');
                    return;
                }
                setIsLoading(true);
                await onLogin(username, password);
                setIsLoading(false);
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
                        <h1 className="text-3xl font-bold text-center text-gray-800 mb-8">Login</h1>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label htmlFor="username" className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input 
                                    type="text" 
                                    id="username" 
                                    value={username} 
                                    onChange={e => setUsername(e.target.value)} 
                                    className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    autoCapitalize="none"
                                />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input 
                                    type="password" 
                                    id="password" 
                                    value={password} 
                                    onChange={e => setPassword(e.target.value)} 
                                    className="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={isLoading}
                                className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400"
                            >
                                {isLoading ? 'Accesso...' : 'Accedi'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ onLogout, onClose, profilo }) => {
            return (
                <div className="modal-overlay" style={{ backgroundColor: 'rgba(0,0,0,0.5)', position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50 }}>
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg m-4 space-y-4">
                        <div className="flex justify-between items-center border-b pb-2">
                            <h2 className="text-xl font-bold">Impostazioni</h2>
                            <button onClick={onClose} className="text-gray-500 text-2xl">&times;</button>
                        </div>
                        <div>
                            <h3 className="text-lg font-semibold mb-2">Profilo Connesso</h3>
                            <p className="text-gray-700"><span className="font-medium">Studio:</span> {profilo?.nome_studio}</p>
                            <p className="text-gray-700"><span className="font-medium">Percorso:</span> {profilo?.drive_path}</p>
                        </div>
                        <div className="pt-4">
                            <button onClick={onLogout} className="w-full bg-red-500 text-white py-2 px-4 rounded-lg">Disconnetti</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const MainView = ({ cognome, setCognome, nome, setNome, dataTest, setDataTest, handleNewPatient, activeCategory, setActiveCategory, handleTakePhoto, stagedFiles, isUploading }) => {
             const renderSubgroupView = () => (
                <div className="bg-white p-6 rounded-xl shadow-md mb-6 space-y-4">
                    <div className="flex items-center justify-between border-b pb-2 mb-4">
                        <h2 className="text-xl font-semibold text-gray-700">{activeCategory}</h2>
                        <button onClick={() => setActiveCategory(null)} className="text-sm text-blue-600 hover:underline">Indietro</button>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        {ALLERGEN_STRUCTURE[activeCategory].map(groupName => (
                             <button key={groupName} onClick={() => handleTakePhoto(groupName)} disabled={isUploading} className={`p-4 text-center font-medium rounded-lg shadow-sm transition-all text-sm ${stagedFiles[groupName] ? 'bg-green-100 border-2 border-green-500 text-green-800' : 'bg-white text-blue-600 border-2 border-blue-500 hover:bg-blue-50' } disabled:bg-gray-200 disabled:text-gray-400 disabled:border-gray-300 disabled:cursor-not-allowed`}>
                                {groupName} {stagedFiles[groupName] ? ' (✓)' : ''}
                            </button>
                        ))}
                    </div>
                </div>
            );
            
            const renderMainCategoryView = () => (
                 <div className="bg-white p-6 rounded-xl shadow-md mb-6 space-y-4">
                    <h2 className="text-xl font-semibold text-gray-700 border-b pb-2">2. Scatta Foto</h2>
                    <div className="grid grid-cols-2 gap-4">
                        {Object.keys(ALLERGEN_STRUCTURE).map(category => (
                            <button key={category} onClick={() => setActiveCategory(category)} className="w-full bg-white border-2 border-blue-500 text-blue-600 font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-50 transition-colors">
                                {category}
                            </button>
                        ))}
                    </div>
                     <button onClick={() => handleTakePhoto("Controllo Positivo (Istamina)")} disabled={isUploading} className={`w-full font-bold py-3 px-4 rounded-lg shadow-md transition-colors ${stagedFiles["Controllo Positivo (Istamina)"] ? 'bg-green-100 border-2 border-green-500 text-green-800' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'} disabled:bg-gray-300 disabled:cursor-not-allowed`}>
                        Controllo Positivo {stagedFiles["Controllo Positivo (Istamina)"] ? ' (✓)' : ''}
                    </button>
                </div>
            );
            return (
                 <>
                    <div className="bg-white p-6 rounded-xl shadow-md mb-6 space-y-4">
                        <div className="flex justify-between items-center border-b pb-2">
                             <h2 className="text-xl font-semibold text-gray-700">1. Dati Paziente</h2>
                             <button onClick={() => handleNewPatient(false)} className="text-sm text-blue-600 hover:underline">Nuovo Paziente</button>
                        </div>
                        <div>
                            <label htmlFor="cognome" className="block text-sm font-medium text-gray-600 mb-1">Cognome</label>
                            <input type="text" id="cognome" value={cognome} onChange={e => setCognome(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label htmlFor="nome" className="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                            <input type="text" id="nome" value={nome} onChange={e => setNome(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label htmlFor="data" className="block text-sm font-medium text-gray-600 mb-1">Data Test</label>
                            <input type="date" id="data" value={dataTest} onChange={e => setDataTest(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                    </div>
                    {activeCategory ? renderSubgroupView() : renderMainCategoryView()}
                </>
            )
        };
        
        const FileList = ({ stagedFiles, handleTakePhoto }) => (
            <div className="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 className="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">File Pronti per il Caricamento</h2>
                {Object.keys(stagedFiles).length === 0 ? (
                    <p className="text-gray-500 text-center py-4">Nessuna foto ancora scattata.</p>
                ) : (
                    <ul className="space-y-3">
                        {Object.entries(stagedFiles).map(([group, {preview}]) => (
                            <li key={group} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <div className="flex items-center space-x-3">
                                    <img src={preview} alt={`Anteprima ${group}`} className="w-16 h-16 object-cover rounded-md bg-gray-200" />
                                    <span className="font-medium text-gray-800">{group}</span>
                                </div>
                                <button onClick={() => handleTakePhoto(group)} className="text-sm text-blue-600 hover:underline">Sostituisci</button>
                            </li>
                        ))}
                    </ul>
                )}
            </div>
        );

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
