<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caricamento Foto Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh */
        }
        input[type="file"] { display: none; }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s, visibility 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>
    <div id="toast" class="toast"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const API_KEY = 'AIzaSyDD1Sd4nw5Fdwcy36ZAB4dSDhVMqOFhJsw';
        const CLIENT_ID = '1091891823693-m0ggq3m0jj5mf72g4ngdrcvoic7fvsrv.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        // *** MODIFICA: Struttura semplificata. Solo "Altri allergeni" ha sottocategorie. ***
        const ALLERGEN_STRUCTURE = {
            "Altri allergeni": ["Leguminose", "Pesci e Molluschi", "Rosacee", "Test Speciali", "Latex"]
        };
        
        function showToast(message, bgColor) {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.className = `toast show ${bgColor}`;
                setTimeout(() => toast.className = toast.className.replace("show", ""), 4000);
            }
        }

        function App() {
            const [cognome, setCognome] = useState('');
            const [nome, setNome] = useState('');
            
            const [gapiReady, setGapiReady] = useState(false);
            const [gisReady, setGisReady] = useState(false);
            const [tokenClient, setTokenClient] = useState(null);
            const [accessToken, setAccessToken] = useState(null);

            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState('');
            const [stagedFiles, setStagedFiles] = useState({});
            const [isFileSystemError, setIsFileSystemError] = useState(false);
            
            const [activeCategory, setActiveCategory] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [drivePath, setDrivePath] = useState('Albanesi/Cartelle_Cliniche_Digitali');

            const fileInputRef = useRef(null);

            // *** CORREZIONE: Gestione race condition caricamento script ***
            useEffect(() => {
                const savedPath = localStorage.getItem('drivePath');
                if (savedPath) setDrivePath(savedPath);

                if (window.location.protocol === 'file:') { setIsFileSystemError(true); return; }

                let gapiLoaded = false;
                let gisLoaded = false;

                function handleGapiLoad() { 
                    if (gapiLoaded) return;
                    gapiLoaded = true;
                    if (window.gapi) {
                        gapi.load('client', initializeGapiClient); 
                    }
                }
                
                function handleGisLoad() {
                    if (gisLoaded) return;
                    gisLoaded = true;
                    if (window.google && window.google.accounts) {
                        const client = google.accounts.oauth2.initTokenClient({
                            client_id: CLIENT_ID, scope: SCOPES,
                            callback: (tokenResponse) => { if (tokenResponse.access_token) setAccessToken(tokenResponse.access_token); },
                        });
                        setTokenClient(client);
                        setGisReady(true);
                    }
                }

                // Controlla se gli script sono già stati caricati
                if (window.gapi) {
                    handleGapiLoad();
                } else {
                    const gapiScript = document.querySelector('script[src="https://apis.google.com/js/api.js"]');
                    if (gapiScript) gapiScript.onload = handleGapiLoad;
                }
                
                if (window.google && window.google.accounts) {
                    handleGisLoad();
                } else {
                    const gisScript = document.querySelector('script[src="https://accounts.google.com/gsi/client"]');
                    if (gisScript) gisScript.onload = handleGisLoad;
                }

            }, []);
            
            async function initializeGapiClient() {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
                setGapiReady(true);
            }

            function handleAuthClick() {
                if (tokenClient) tokenClient.requestAccessToken({}); 
                else showToast("Client di autenticazione non pronto.", 'bg-yellow-500 text-black');
            }

            function handleSignoutClick() {
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken, () => { setAccessToken(null); showToast("Disconnessione riuscita.", 'bg-gray-500'); });
                }
            }

            const handleTakePhoto = (groupName) => {
                if (!cognome || !nome) { showToast("Inserisci Nome e Cognome del paziente.", 'bg-yellow-500 text-black'); return; }
                fileInputRef.current.onchange = (event) => handleFileChange(event, groupName);
                fileInputRef.current.click();
            };

            const handleFileChange = (event, groupName) => {
                const file = event.target.files[0];
                if (file) {
                    const previewUrl = URL.createObjectURL(file);
                    if (stagedFiles[groupName] && stagedFiles[groupName].preview) {
                        URL.revokeObjectURL(stagedFiles[groupName].preview);
                    }
                    setStagedFiles(prev => ({ ...prev, [groupName]: { file, preview: previewUrl } }));
                    showToast(`Foto per "${groupName}" aggiunta.`, 'bg-blue-500');
                }
                event.target.value = null; 
            };
            
            const handleUploadAll = async () => {
                if (!gapiReady) {
                    showToast("L'API di Google non è ancora pronta. Riprova tra un istante.", 'bg-yellow-500 text-black');
                    return;
                }
                if (!accessToken || Object.keys(stagedFiles).length === 0) {
                    showToast(accessToken ? "Nessuna foto da caricare." : "Autenticazione Google Drive necessaria.", 'bg-red-500');
                    return;
                }
                setIsUploading(true);
                const filesToUpload = Object.entries(stagedFiles);
                try {
                    const pathParts = drivePath.split('/').filter(p => p.trim() !== '');
                    let currentParentId = 'root';
                    for (const part of pathParts) {
                        currentParentId = await findOrCreateFolder(part, currentParentId);
                    }
                    const baseFolderId = currentParentId;

                    const patientFolderName = `${cognome.trim()}_${nome.trim()}`;
                    const patientFolderId = await findOrCreateFolder(patientFolderName, baseFolderId);

                    for (let i = 0; i < filesToUpload.length; i++) {
                        const [groupName, { file }] = filesToUpload[i];
                        setUploadProgress(`Caricamento ${i + 1}/${filesToUpload.length}: "${groupName}"...`);
                        
                        // *** MODIFICA: Logica di caricamento aggiornata ***
                        // Cerca se appartiene a una sottocartella (es. "Altri allergeni")
                        let mainCategory = Object.keys(ALLERGEN_STRUCTURE).find(cat => ALLERGEN_STRUCTURE[cat].includes(groupName));
                        
                        if (groupName === "Controllo Positivo (Istamina)") {
                            // Carica nella cartella paziente
                            await uploadSingleFile(file, groupName, patientFolderId);
                        } else if (groupName === "Alimenti" || groupName === "Inalanti") {
                            // Crea una cartella per "Alimenti" o "Inalanti" e carica lì
                            const categoryFolderId = await findOrCreateFolder(groupName, patientFolderId);
                            await uploadSingleFile(file, groupName, categoryFolderId);
                        } else if (mainCategory) {
                            // Appartiene a "Altri allergeni", crea la sottocartella
                             const categoryFolderId = await findOrCreateFolder(mainCategory, patientFolderId);
                             await uploadSingleFile(file, groupName, categoryFolderId);
                        } else {
                            // Fallback: carica direttamente nella cartella paziente
                            console.warn(`Nessuna categoria trovata per ${groupName}, caricamento nella root del paziente.`);
                            await uploadSingleFile(file, groupName, patientFolderId);
                        }
                    }
                    showToast('Tutti i file sono stati caricati!', 'bg-green-500');
                    handleNewPatient(true);
                } catch (error) {
                    showToast(`Errore durante il caricamento: ${error.message}`, 'bg-red-500');
                } finally {
                    setIsUploading(false);
                    setUploadProgress('');
                }
            };

            async function uploadSingleFile(file, groupName, parentFolderId) {
                const fileName = `${groupName}.jpg`;
                const metadata = { name: fileName, parents: [parentFolderId], mimeType: 'image/jpeg' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }), body: form,
                });
                const result = await response.json();
                if (result.error) throw new Error(`${result.error.message} (file: ${fileName})`);
            }

            async function findOrCreateFolder(name, parentId) {
                const query = `mimeType='application/vnd.google-apps.folder' and trashed=false and name='${name}' and '${parentId}' in parents`;
                const response = await gapi.client.drive.files.list({ q: query, fields: 'files(id)', spaces: 'drive' });
                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                }
                const fileMetadata = { name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] };
                const createResponse = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                return createResponse.result.id;
            }
            
            const handleNewPatient = (force = false) => {
                const confirmed = force || Object.keys(stagedFiles).length === 0 || confirm("Hai foto non caricate. Vuoi iniziare con un nuovo paziente? Le foto andranno perse.");
                if (confirmed) {
                    Object.values(stagedFiles).forEach(({preview}) => {
                        if (preview) URL.revokeObjectURL(preview);
                    });
                    setStagedFiles({}); setCognome(''); setNome(''); setActiveCategory(null);
                }
            };

            if (isFileSystemError) return ( <div className="min-h-screen bg-red-50 flex items-center justify-center p-4"><div className="bg-white p-8 rounded-xl shadow-2xl max-w-lg text-center"><h1 className="text-2xl font-bold text-red-700 mb-4">Errore di Avvio</h1><p className="text-gray-700 mb-2">Questa applicazione non può essere eseguita da un file locale (<code className="bg-red-100 text-red-900 p-1 rounded">file://</code>).</p><p className="text-gray-700 font-medium">Per funzionare, deve essere avviata tramite un server web locale (es. con l'estensione "Live Server" di VS Code).</p></div></div> );

            return (
                <div className="min-h-screen bg-gray-50 p-4 pb-20 max-w-2xl mx-auto">
                    {showSettings && <SettingsModal 
                        drivePath={drivePath} 
                        setDrivePath={setDrivePath} 
                        onClose={() => setShowSettings(false)} 
                        onAuth={handleAuthClick} 
                        onSignout={handleSignoutClick} 
                        accessToken={accessToken}
                        gisReady={gisReady} 
                    />}

                    <header className="bg-white p-4 rounded-xl shadow-md mb-6 sticky top-4 z-10">
                        <div className="flex items-center justify-between">
                            <h1 className="text-2xl font-bold text-gray-800">Caricamento Foto</h1>
                             <button onClick={() => setShowSettings(true)} className="text-gray-500 hover:text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                             </button>
                        </div>
                         {!(gapiReady && gisReady) && <p className="text-center text-gray-500 mt-2">Inizializzazione API Google...</p>}
                         {gapiReady && gisReady && !accessToken && <p className="text-center text-red-500 font-medium mt-2">Accesso a Google Drive richiesto. Vai nelle impostazioni per accedere.</p>}
                    </header>
                    
                    <MainView 
                        cognome={cognome} setCognome={setCognome} 
                        nome={nome} setNome={setNome} 
                        handleNewPatient={handleNewPatient} 
                        activeCategory={activeCategory} setActiveCategory={setActiveCategory} 
                        handleTakePhoto={handleTakePhoto} 
                        stagedFiles={stagedFiles} accessToken={accessToken} isUploading={isUploading}
                    />
                    
                    <FileList stagedFiles={stagedFiles} handleTakePhoto={handleTakePhoto} />

                    <button onClick={handleUploadAll} disabled={!accessToken || isUploading || Object.keys(stagedFiles).length === 0} className="w-full bg-green-500 text-white font-bold py-4 px-4 rounded-lg shadow-lg hover:bg-green-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed text-lg sticky bottom-4 z-10">
                        {isUploading ? uploadProgress : `Carica ${Object.keys(stagedFiles).length} File su Drive`}
                    </button>

                    <input type="file" accept="image/*" ref={fileInputRef} />
                </div>
            );
        }

        const SettingsModal = ({ drivePath, setDrivePath, onClose, onAuth, onSignout, accessToken, gisReady }) => {
            const [localPath, setLocalPath] = useState(drivePath);
            const handleSave = () => {
                setDrivePath(localPath);
                localStorage.setItem('drivePath', localPath);
                showToast("Impostazioni salvate.", "bg-green-500");
                onClose();
            };
            return (
                <div className="modal-overlay">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg m-4 space-y-4">
                        <div className="flex justify-between items-center border-b pb-2">
                            <h2 className="text-xl font-bold">Impostazioni</h2>
                            <button onClick={onClose} className="text-gray-500 text-2xl">&times;</button>
                        </div>
                        <div>
                            <label htmlFor="drivePathInput" className="block text-sm font-medium text-gray-600 mb-1">Percorso Cartella su Drive</label>
                            <input type="text" id="drivePathInput" value={localPath} onChange={e => setLocalPath(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Es. Cartella1/Cartella2"/>
                            <p className="text-xs text-gray-500 mt-1">Separa i nomi delle cartelle con uno slash (/).</p>
                        </div>
                        <div>
                            <h3 className="text-lg font-semibold mb-2">Account Google</h3>
                            {accessToken ? 
                                <button onClick={onSignout} className="w-full bg-red-500 text-white py-2 px-4 rounded-lg">Disconnetti</button> :
                                <button 
                                    onClick={onAuth} 
                                    disabled={!gisReady} 
                                    className="w-full bg-blue-500 text-white py-2 px-4 rounded-lg disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    {gisReady ? "Accedi a Google" : "Inizializzazione..."}
                                </button>
                            }
                        </div>
                        <div className="flex justify-end pt-4">
                            <button onClick={handleSave} className="bg-green-500 text-white font-bold py-2 px-6 rounded-lg">Salva</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const MainView = ({ cognome, setCognome, nome, setNome, handleNewPatient, activeCategory, setActiveCategory, handleTakePhoto, stagedFiles, accessToken, isUploading }) => {
             const renderSubgroupView = () => (
                <div className="bg-white p-6 rounded-xl shadow-md mb-6 space-y-4">
                    <div className="flex items-center justify-between border-b pb-2 mb-4">
                        <h2 className="text-xl font-semibold text-gray-700">{activeCategory}</h2>
                        <button onClick={() => setActiveCategory(null)} className="text-sm text-blue-600 hover:underline">Indietro</button>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        {ALLERGEN_STRUCTURE[activeCategory].map(groupName => (
                             <button 
                                key={groupName} 
                                onClick={() => handleTakePhoto(groupName)} 
                                disabled={isUploading || !accessToken} 
                                className={`p-4 text-center font-medium rounded-lg shadow-sm transition-all text-sm ${
                                    stagedFiles[groupName] 
                                        ? 'bg-green-100 border-2 border-green-500 text-green-800' 
                                        : 'bg-white text-blue-600 border-2 border-blue-500 hover:bg-blue-50' 
                                } disabled:bg-gray-200 disabled:text-gray-400 disabled:border-gray-300 disabled:cursor-not-allowed`}
                            >
                                {groupName} {stagedFiles[groupName] ? ' (✓)' : ''}
                            </button>
                        ))}
                    </div>
                </div>
            );
            
            const renderMainCategoryView = () => (
                 <div className="bg-white p-6 rounded-xl shadow-md mb-6 space-y-4">
                    <h2 className="text-xl font-semibold text-gray-700 border-b pb-2">2. Scatta Foto</h2>
                    
                    <div className="grid grid-cols-2 gap-4">
                        <button 
                            onClick={() => handleTakePhoto("Alimenti")} 
                            disabled={!accessToken || isUploading} 
                            className={`w-full font-bold py-3 px-4 rounded-lg shadow-md transition-colors text-center ${
                                stagedFiles["Alimenti"] 
                                    ? 'bg-green-100 border-2 border-green-500 text-green-800' 
                                    : 'bg-white border-2 border-blue-500 text-blue-600 hover:bg-blue-50'
                            } disabled:bg-gray-300 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed`}
                        >
                            Alimenti {stagedFiles["Alimenti"] ? ' (✓)' : ''}
                        </button>
                        
                        <button 
                            onClick={() => handleTakePhoto("Inalanti")} 
                            disabled={!accessToken || isUploading} 
                            className={`w-full font-bold py-3 px-4 rounded-lg shadow-md transition-colors text-center ${
                                stagedFiles["Inalanti"] 
                                    ? 'bg-green-100 border-2 border-green-500 text-green-800' 
                                    : 'bg-white border-2 border-blue-500 text-blue-600 hover:bg-blue-50'
                            } disabled:bg-gray-300 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed`}
                        >
                            Inalanti {stagedFiles["Inalanti"] ? ' (✓)' : ''}
                        </button>

                        {Object.keys(ALLERGEN_STRUCTURE).map(category => (
                            <button 
                                key={category} 
                                onClick={() => setActiveCategory(category)} 
                                disabled={!accessToken || isUploading}
                                className="w-full bg-white border-2 border-blue-500 text-blue-600 font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-50 transition-colors disabled:bg-gray-300 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                            >
                                {category}
                            </button>
                        ))}
                    </div>
                    
                     <button onClick={() => handleTakePhoto("Controllo Positivo (Istamina)")} disabled={!accessToken || isUploading} className={`w-full font-bold py-3 px-4 rounded-lg shadow-md transition-colors ${stagedFiles["Controllo Positivo (Istamina)"] ? 'bg-green-100 border-2 border-green-500 text-green-800' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'} disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed`}>
                        {/* *** CORREZIONE: Refuso "Controlto" -> "Controllo" *** */}
                        Controllo Positivo {stagedFiles["Controllo Positivo (Istamina)"] ? ' (✓)' : ''}
                    </button>
                </div>
            );

            return (
                 <>
                    <div className="bg-white p-6 rounded-xl shadow-md mb-6 space-y-4">
                        <div className="flex justify-between items-center border-b pb-2">
                             <h2 className="text-xl font-semibold text-gray-700">1. Dati Paziente</h2>
                             <button onClick={() => handleNewPatient(false)} className="text-sm text-blue-600 hover:underline">Nuovo Paziente</button>
                        </div>
                        <div>
                            <label htmlFor="cognome" className="block text-sm font-medium text-gray-600 mb-1">Cognome</label>
                            <input type="text" id="cognome" value={cognome} onChange={e => setCognome(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                        <div>
                            <label htmlFor="nome" className="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                            <input type="text" id="nome" value={nome} onChange={e => setNome(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                        </div>
                    </div>
                    {activeCategory ? renderSubgroupView() : renderMainCategoryView()}
                </>
            )
        };
        
        const FileList = ({ stagedFiles, handleTakePhoto }) => (
            <div className="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 className="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">File Pronti per il Caricamento</h2>
                {Object.keys(stagedFiles).length === 0 ? (
                    <p className="text-gray-500 text-center py-4">Nessuna foto ancora scattata.</p>
                ) : (
                    <ul className="space-y-3">
                        {Object.entries(stagedFiles).map(([group, {preview}]) => (
                            <li key={group} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <div className="flex items-center space-x-3">
                                    <img src={preview} alt={`Anteprima ${group}`} className="w-16 h-16 object-cover rounded-md bg-gray-200" />
                                    <span className="font-medium text-gray-800">{group}</span>
                                </div>
                                <button onClick={() => handleTakePhoto(group)} className="text-sm text-blue-600 hover:underline">Sostituisci</button>
                            </li>
                        ))}
                    </ul>
                )}
            </div>
        );

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

